---
page_type: sample
description: "В этом примере веб-приложения ASP.NET Core показан порядок подписки на веб-перехватчики с помощью делегированных разрешений."
products:
- office-outlook
- office-365
- ms-graph
languages:
- csharp
extensions:
  contentType: samples
  technologies:
  - Microsoft Graph 
  - Microsoft identity platform
  services:
  - Outlook
  - Office 365
  - Microsoft identity platform
  createdDate: 3/3/2017 8:55:02 AM
---
# Пример веб-перехватчиков Microsoft Graph для ASP.NET Core

Подпишитесь на [веб-перехватчики Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks) для получения оповещений об изменениях ваших данных пользователя, чтобы не выполнять опрос на изменения.

В этом примере веб-приложения ASP.NET Core показан порядок подписки на веб-перехватчики с помощью делегированных разрешений. В нем используется OpenID Connect для входа в систему и выхода из нее с помощью платформы удостоверений Майкрософт для разработчиков, [библиотека проверки подлинности Майкрософт для .NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet) (MSAL.NET), чтобы получить маркер доступа с помощью [потока кода авторизации](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow), и [Клиентская библиотека Microsoft Graph для .NET](https://github.com/microsoftgraph/msgraph-sdk-dotnet) (SDK) для вызова Microsoft Graph от имени пользователя, который успешно выполнил вход в веб-приложение. Эти сложности были включены в проект библиотеки повторного использования `Microsoft.Identity.Web`. 

>См. список [делегированных разрешений,](https://docs.microsoft.com/en-us/graph/api/subscription-post-subscriptions?view=graph-rest-1.0) разрешенных для каждого поддерживаемого ресурса в Microsoft Graph.

Пример приложения перенаправляется в конечную точку Azure AD *adminconsent* и таким образом администратор клиента может предоставлять делегированные разрешения непосредственно приложению. После согласия администратора пользователи в клиенте могут создавать подписку и просматривать уведомления. 

Ниже приведены некоторые общие задачи, выполняемые приложением при наличии подписки на веб-перехватчики:

- Получение согласия на подписку на ресурсы пользователей, а затем получение маркера доступа.
- Использование маркера доступа, чтобы [создать подписку](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/api/subscription_post_subscriptions) на ресурс.
- Возврат маркера проверки для подтверждения URL-адреса уведомления.
- Отслеживание уведомлений из Microsoft Graph и ответ с кодом состояния 202.
- Запрос дополнительных сведений об измененных ресурсах с помощью данных в уведомлении.

## Использование примера веб-перехватчиков Microsoft Graph

На снимке экрана ниже показана страница запуска приложения. 
  
![Снимок экрана для примера веб-перехватчиков Microsoft Graph для ASP.NET Core](readme-images/Page1.PNG)

После того как приложение создаст подписку для вошедшего в систему пользователя Microsoft Graph отправляет уведомление в зарегистрированную конечную точку, если происходят события на ресурсе, на который подписан пользователь. Приложение реагирует на событие.

Этот пример приложения выполняет подписку на ресурс `users/{user-id}/mailFolders('Inbox')/messages` для изменений`created` (создано). При получении уведомления о том, что подписанные пользователи получат сообщение электронной почты, приложение обновляет страницу со сведениями о сообщении. На странице отображаются только сообщения, относящиеся к пользователю, выполнившему вход в систему.

### Необходимые компоненты

Чтобы использовать пример веб-перехватчика Microsoft Graph для ASP.NET Core, потребуется следующее:

- Набор инструментов Visual Studio 2017, установленный на компьютере для разработки. 
- Установленный .NET Core 2,1 или более поздней версии (например, для Windows). Вы можете следовать инструкциям, приведенным в документе [.NET и C# - Начало работы за 10 минут](https://www.microsoft.com/net/core). Кроме разработки в Windows, вы можете выполнять разработку в [Linux](https://www.microsoft.com/net/core#linuxredhat), [Mac](https://www.microsoft.com/net/core#macos) или [Docker](https://www.microsoft.com/net/core#dockercmd).
- [Рабочая, учебная или личная учетная запись](https://dev.office.com/devprogram). Для предоставления разрешений приложению необходима учетная запись администратора клиента. 
- Идентификатор приложения и ключ из приложения, которое вы [регистрируете на портале Azure](#register-the-app). 
- Открытая конечная точка HTTPS для получения и отправки HTTP-запросов. Вы можете разместить ее на Microsoft Azure или другой службе, а также [использовать ngrok](#ngrok) или аналогичный инструмент во время тестирования.

### Создание приложения

#### Выбор клиента, в котором вы хотите создать приложение

1. Войдите на [портал Azure](https://portal.azure.com) с помощью рабочей или учебной учетной записи.
1. Если ваша учетная запись содержится в нескольких клиентах Azure AD:
   1. Выберите профиль в меню в правом верхнем углу, а затем выберите пункт **Переключение каталога**.
   1. Измените сеанс на клиента Azure AD, в котором вы хотите создать приложение.

#### Регистрация приложения

1. Перейдите к пункту [Портал Azure > Регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908), чтобы зарегистрировать приложение.
1. Выберите **Новая регистрация**.
1. После появления страницы **Регистрация приложения** введите сведения о регистрации для своего приложения:
   1. В разделе **Имя** введите понятное имя, которое будет отображаться для пользователей приложения. Например: `MyWebApp`
   1. В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации и личные учетные записи Майкрософт (например, Skype, Xbox, Outlook.com)**.
      > При наличии нескольких URI перенаправления вам потребуется добавить их позже из вкладки **Проверка подлинности** после успешного создания приложения.
1. Выберите **Зарегистрировать**, чтобы создать приложение.
1. На странице приложения **Обзор** найдите значение **Идентификатор приложения (клиент)** и запишите его, чтобы использовать позже. Вам потребуется это значение, чтобы настроить файл конфигурации Visual Studio для данного проекта.
1. В списке страниц приложения выберите **Проверка подлинности**.
   1. В разделе **URI перенаправления** выберите параметр **Веб** в поле со списком и введите указанные URI перенаправления.
       - `https://localhost:44334/signin-oidc`
       - `https://localhost:44334/Account/GrantPermissions`
1. Нажмите кнопку **Сохранить**.
1. На странице **Сертификаты и секреты** в разделе **Секреты клиента** выберите **Новый секрет клиента**.
   1. Введите описание ключа (например, `секрет приложения`).
   1. Выберите, когда истекает срок действия ключа: **Через один год**, **Через два года** или **Никогда**.
   1. После нажатия на кнопку **Добавить** отобразится значение ключа. Скопируйте значение ключа и сохраните его в безопасном месте.

      Этот ключ потребуется позже, чтобы настроить проект в Visual Studio. Это значение ключа больше не будет отображаться и его невозможно получить каким-либо другим способом, поэтому запишите его, как только оно появится на портале Azure.

1. В списке страниц приложения выберите **Разрешения API**.
   1. Нажмите кнопку **Добавить разрешение** и убедитесь, что выбрана вкладка **Microsoft APIs**.
   1. В разделе **Часто используемые интерфейсы Microsoft API** выберите **Microsoft Graph**
   1. Убедитесь в том, что в разделе **Разрешения приложения** отмечено разрешение на чтение почты **Mail.Read**. При необходимости используйте поле поиска.
    > Кроме того, в разделе **Делегированные разрешения** отметьте делегированное разрешение User.Read для Azure Active Directory, чтобы пользователи могли войти в приложение для запуска процесса подписки.
   1. Нажмите кнопку **Добавить разрешения**.
   
<a name="ngrok"></a>
### Настройка прокси-сервера ngrok (необязательно) 
Чтобы создать подписку и получать уведомления от Microsoft Graph, нужно предоставить открытую конечную точку HTTPS. Во время тестирования вы можете использовать ngrok для временного разрешения туннелирования сообщений из Microsoft Graph на порт *localhost* на вашем компьютере. 

Можно использовать веб-интерфейс ngrok (http://127.0.0.1:4040), чтобы проверить трафик HTTP, проходящий по туннелю. Дополнительные сведения об использовании ngrok см. в статье [веб-сайт ngrok](https://ngrok.com/).  

1. В Обозревателе решений щелкните правой кнопкой мыши на проекте **GraphWebhooks-Core** и выберите пункт **Свойства**. 

1. На вкладке **Отладка** скопируйте номер порта **URL-адреса приложения**. 

	![Номер порта URL-адреса в окне Свойства](readme-images/PortNumber.png)

1. [Скачайте ngrok](https://ngrok.com/download) для Windows.  

1. Распакуйте пакет и запустите ngrok. exe.

1. Замените два значения заполнителей *{port-number}* в следующей команде на номер порта, который вы скопировали, а затем запустите команду в консоли ngrok.

   `ngrok http {port-number} -host-header=localhost:{port-number}`

	![Пример команды для выполнения в консоли ngrok](readme-images/ngrok1.PNG)

1. Скопируйте URL-адрес HTTPS, который отображается на консоли. Вы будете использовать его для настройки URL-адреса уведомления в примере.

	![URL-адрес переадресации HTTPS на консоли ngrok](readme-images/ngrok2.PNG)

Не закрывайте консоль во время тестирования. Если вы ее закроете, то также закроется туннель и вам потребуется создать новый URL-адрес и обновить пример.

>В статье [Размещение без туннеля](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample/wiki/Hosting-the-sample-without-a-tunnel) и [Зачем использовать туннель?](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample/wiki/Why-do-I-have-to-use-a-tunnel) приведены дополнительные сведения об использовании туннелей.


## Настройка и запуск примера

1. Для установки клиентского пакета ASP.NET Core SignalR Javascript в приложение следуйте [инструкциям](https://docs.microsoft.com/en-us/aspnet/core/signalr/javascript-client?view=aspnetcore-2.2) ниже.
1. Предоставьте открытую конечную точку HTTPS для уведомлений. Она может работать в службе, например в Microsoft Azure, или вы можете создать прокси веб-сервер [с помощью ngrok](#ngrok) или аналогичных средств.

1. Откройте файл примера **GraphWebhooks-Core.sln** в Visual Studio 2017.

1. В обозревателе решений откройте файл **appsettings.json** в корневом каталоге проекта.  
 
   - Для ключа **NotificationUrl** замените *ENTER_YOUR_URL* на URL-адрес HTTPS. Оставьте часть */notification/listen*. 

   Если вы используете ngrok, то используйте скопированный URL-адрес HTTPS. Значение будет выглядеть следующим образом:

   `"NotificationUrl": "https://2885f9c5.ngrok.io/notification/listen",`

   Это конечная точка URL-адреса, которая будет получать обратные вызовы проверки подписки и события уведомлений из Graph через прокси-сервер, настроенный выше (в данном примере это ngrok).

1. В обозревателе решений щелкните правой кнопкой мыши на названии проекта и выберите пункт **Управление секретами пользователя**. Это приложение использует [Диспетчер секретов](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-2.2) для хранения конфиденциальных данных приложения — ClientId и ClientSecret.
    
    - В открывшемся окне **secret.json** вставьте приведенный ниже код.
        
        `"AzureAd": {
        "ClientId": "ENTER_YOUR_APP_ID",
        "ClientSecret": "ENTER_YOUR_SECRET"
  }`

    - Для ключа **ClientId** замените *ENTER_YOUR_APP_ID* идентификатором приложения своего зарегистрированного приложения Azure.  
    - Для ключа **ClientSecret** замените *ENTER_YOUR_SECRET* ключом своего зарегистрированного приложения Azure. Обратите внимание на то, что в производственных приложениях всегда следует использовать сертификаты в качестве секретов приложений, но в этом примере мы будем использовать простой общий секретный пароль.

1. Убедитесь в том, что консоль ngrok работает, и нажмите клавишу F5, чтобы построить и выполнить решение в режиме отладки. 

   >Если при установке пакетов возникают ошибки, то убедитесь, что локальный путь к решению не слишком длинный/глубокий. Чтобы устранить эту проблему, переместите решение ближе к корневому диску.

### Использование приложения для создания подписки
 

1. В правом верхнем углу нажмите кнопку **Вход**, а затем выполните вход с помощью рабочей или учебной учетной записи.

1. Дайте согласие на разрешения **Просмотр основного профиля** и **Войти под своей учетной записью**. 

1. На домашней странице примера выберите **Дать согласие администратора**. Вы будете перенаправлены на страницу согласия администратора *adminconsent*.

1. Войдите в систему как администратор клиента и дайте согласие на разрешения **Чтение почты во всех почтовых ящиках** и **Вход и чтение профиля пользователя**. Вы будете повторно перенаправлены на домашнюю страницу примера. 

   На этом этапе любой пользователь в вашем клиенте может выполнить вход и создать подписку. Если вы сначала не предоставили разрешения администратора, то появится сообщение об ошибке *Не авторизован*. Вам потребуется открыть пример в новом сеансе браузера, так как в этом примере кэшируется первоначальный маркер.
    
1. Выберите **Создать подписку**. Загружается страница **Подписка** со всей информацией о подписке.

   >В этом примере срок действия подписки для целей тестирования истекает через 15 минут.

	![Страница приложения, на которой показаны свойства новой подписки](readme-images/Page2.PNG)
	
1. Нажмите кнопку **Посмотреть уведомления**. 

1. Отправьте сообщение электронной почты на вашу учетную запись пользователя. На странице **Уведомление** отображаются свойства сообщения. Обновление страницы может занять несколько секунд.

1. При необходимости нажмите кнопку **Удалить подписку**. 


## Ключевые компоненты примера 
В следующих файлах приведен код, связанный с подключением к Microsoft Graph, созданием подписок и обработкой уведомлений.

- [`appsettings.json`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/appsettings.json) содержит значения, которые используются для проверки подлинности, авторизации и URL-адресов конечных точек. 
- secrets.json содержит ClientId и ClientSecret, которые используются для проверки подлинности и авторизации. Чтобы убедиться в том, что они настроены для проекта, выполните следующую команду из каталога, в котором находится файл csproj:
`dotnet user-secrets list`
- [`Startup.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Startup.cs) настраивает приложение и используемые службы, включая проверку подлинности.

### Контроллеры  
- [`AccountController.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Controllers/AccountController.cs) обрабатывает согласие администратора.  
- [`NotificationController.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Controllers/NotificationController.cs) получает уведомления.  
- [`SubscriptionContoller.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Controllers/SubscriptionController.cs) создает и удаляет подписки.

### Модели
- [`Notification.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Models/Notification.cs) обозначает уведомление об изменениях.
- [`MessageViewModel.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Models/MessageViewModel.cs) определяет **MessageViewModel**, которая обозначает данные, отображаемые в представлении «Уведомление».

### Вспомогательные средства
- [`GraphServiceClientFactory.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Helpers/GraphServiceClientFactory.cs) инициирует клиента SDK, используемого для взаимодействия с Microsoft Graph.
- [`SubscriptionStore.cs`](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/blob/master/src/GraphWebhooks-Core/Helpers/SubscriptionStore.cs) уровень доступа для сохраненных сведений о подписке. В примере временно хранятся сведения в HttpRuntime.Cache. Рабочие приложения обычно используют постоянное хранилище.

### Microsoft. Identity. Web
- Вспомогательная библиотека, содержащая набор многократно используемых классов, которые полезны для облегчения описанной ниже возможности:
    
    - Проверка подлинности и вход пользователей с помощью рабочих, учебных и личных учетных записей Майкрософт на платформе удостоверений Майкрософт версии 2.0 (AAD версии 2.0) с использованием промежуточного слоя OpenId Connect и MSAL.NET. 
    - Обработка выхода из системы и удаление учетной записи из кэша MSAL.NET.
    - Получение маркера от имени пользователя, выполнившего вход.
    - Начальная загрузка веб-ресурса из файла `Startup.cs` в приложении с использованием нескольких способов.



## Устранение неполадок 

| Проблема | Решение |
|:------|:------|
| При попытке создания подписки вы получаете ответ 403 (Доступ запрещен). | Убедитесь в том, что регистрация приложения включает разрешение приложения **Mail.Read** для Microsoft Graph (как описано в разделе [Регистрация приложения](#register-the-app)), и что администратор клиента дал согласие на доступ к приложению. |  
| Вы не получаете уведомления. | Если вы используете ngrok, то вы можете воспользоваться веб-интерфейсом (http://127.0.0.1:4040), чтобы узнать, было ли получено уведомление. Если вы не используете ngrok, следите за сетевым трафиком с помощью средств, предоставляемых службой хостинга, или попробуйте использовать ngrok.<br />Если приложение Microsoft Graph не отправляет уведомления, откройте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph), вопрос с пометкой *[MicrosoftGraph]*. Укажите идентификатор подписки, время создания и идентификатор запроса из ответа (при наличии).<br /><br />Известная проблема Иногда уведомление бывает получено, а извлеченное сообщение отправлено в службу уведомлений, но клиент SignalR в этом примере не обновляется. В таком случае это, как правило, первое уведомление после создания подписки. |  
| Вы получили ответ *Истекло время ожидания запроса на проверку подписки*. | Это означает, что в Microsoft Graph не пришел ответ о проверке в течение 10 секунд.<br /><br />Если вы используете ngrok, убедитесь, что ваша конечная точка доступна и вы указали HTTP-порт вашего проекта для туннеля (не HTTPS). |  
| При установке пакетов возникают ошибки. | Убедитесь, что локальный путь к решению не слишком длинный/глубокий. Чтобы устранить эту проблему, необходимо переместить решение ближе к корневому диску. |
| Ошибки сборки, связанные с Microsoft.AspNetCore.SignalR.Server | Введите эту команду в консоли диспетчера пакетов: 'Install-Package Microsoft.AspNetCore.SignalR.Server -Version 0.2.0-rtm-22752 -Source https://dotnet.myget.org/F/aspnetcore-master/api/v3/index.json' |
| Приложение открывается на странице *Ошибка сервера в приложении '/'. Ресурс не найден.* | Убедитесь в том, что файл представления CSHTML не является активным при запуске приложения из Visual Studio. |

## Участие

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.MD](/CONTRIBUTING.md).

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [часто задаваемых вопросов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Вопросы и комментарии

Мы будем рады получить ваши отзывы о примере веб-перехватчиков Microsoft Graph Webhooks для ASP.NET Core. Вы можете отправлять нам вопросы и предложения в разделе [Проблемы](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample/issues) этого репозитория.

Общие вопросы о Microsoft Graph следует задавать на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph). Убедитесь, что ваши вопросы или комментарии содержат метку *[MicrosoftGraph]*.

Можно предложить изменения в Microsoft Graph на [UserVoice](https://officespdev.uservoice.com/).

## Дополнительные ресурсы

- [Пример веб-перехватчиков Microsoft Graph для ASP.NET 4.6](https://github.com/microsoftgraph/aspnet-webhooks-rest-sample) (делегированные разрешения)
- [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample) (делегированные разрешения)
- [Работа с веб-перехватчиками в Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks)
- [Ресурс подписки](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/subscription)
- [Документация по Microsoft Graph](https://developer.microsoft.com/graph)

## Авторские права
(c) Корпорация Майкрософт (Microsoft Corporation), 2019. Все права защищены.
